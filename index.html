<!DOCTYPE html>
<meta charset="utf-8">
<head>

<!-- Load d3.js-->
<!-- <script src="https://d3js.org/d3.v4.js"></script> -->
<script src="js/libs/d3.v4.js"></script>

<!-- Load d3-legend
<script src="https://cdnjs.com/libraries/d3-legend"></script>-->
<script src="js/libs/d3-legend.min.js"></script>

<!-- load noUiSlider, see  https://refreshless.com/nouislider -->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.js" integrity="sha512-T5Bneq9hePRO8JR0S/0lQ7gdW+ceLThvC80UjwkMRz+8q+4DARVZ4dqKoyENC7FcYresjfJ6ubaOgIE35irf4w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.css" integrity="sha512-MKxcSu/LDtbIYHBNAWUQwfB3iVoG9xeMCm32QV5hZ/9lFaQZJVaXfz9aFa0IZExWzCpm7OWvp9zq9gVip/nLMg==" crossorigin="anonymous" referrerpolicy="no-referrer" />-->
<script src="js/libs/nouislider.v15.5.1.min.js"></script>
<link rel="stylesheet" href="css/nouislider.v15.5.1.css"/>

<!--Load components: -->
<script src="js/utils.js"></script>
<script src="js/urlParser.js"></script>
<script src="js/apiCalls.js"></script>
<script src="js/dataPreparation.js"></script>
<script src="js/sliderCreation.js"></script>
<!--<script src="js/updateCharts.js"></script>-->
<script src="js/filterFunctions.js"></script>
<script src="js/buildScatter.js"></script>
<script src="js/buildLegends.js"></script>
<script src="js/buildSideBar.js"></script>
<script src="js/buildBar.js"></script>
<script src="js/buildTable.js"></script>
<script src="js/main.js"></script>


<link rel="stylesheet" href="css/main.css"/>
</head>

<body>
  <div>
    <button onclick="loadNuwayri()">Load Nuwayri</button>
    <button onclick="loadIstakhri()">Load Istakhri</button>
    <button onclick="loadTarikh()">Load Tarikh</button>
    <button onclick="loadTahdhib()">Load Tahdhib</button>
    <button onclick="loadTafsir()">Load Tafsir</button>
    <span>NB: use query string to load another book (currently only Nuwayrī): http://127.0.0.1:60887?id1=Shamela0010283</span>
    <!--<form id="csvForm" method="post" enctype="multipart/form-data">
      <label for="file">Alternatively, choose CSV file to upload (does not work yet):</label>
      <input type="file" id="file" name="file" accept=".csv" />
      <button>Submit</button>
    </form>-->
    <label for="file">Alternatively, choose CSV file to upload:</label>
    <input type="file" id="file" name="file" onchange="loadCSV()" />
  </div>
  
  <h1 id="pageTitle">Text reuse in Nuwayrī's Nihāya for all books in the OpenITI corpus</h1>
  <!-- Create a div where the graph(s) will live -->
  <div id="legendContainer">
    <div id="legend" style="width: 50%; float: left; "></div>
    <div id="colorpicker" style="float: left; padding-top: 30px;">
        <input type="radio" id="heat" name="color_radio" value="heat" checked>
        <label for="heat">heat</label>
        <input type="radio" id="blues" name="color_radio" value="blues">
        <label for="blues">blues</label>
    </div>
  </div>
  <div id="viz" style="float: left;"></div>
  <div id="viz3" style="float: left; "></div>
  <div id="viz2"></div>
  <!-- Create a div where the filters will live -->
  <div id="filters"></div>
  <div id="stats-table-div">
    <table id="stats-table">
      <thead id="stats-table-head">
          <th class="sort-col-head">ID</td>
          <th class="sort-col-head">URI</td>
          <th class="sort-col-head">Alignments</td>
          <th class="sort-col-head">Matching characters</td>
      </thead>
      <tbody id="stats-table-body"></tbody>
    </table>
  </div>
  <div id="eventhandle-div"></div> <!--https://observablehq.com/@sarah37/snapping-range-slider-with-d3-brush-->
</body>

<script>

const dataBasePath = "data/"

let OpenITIVersion = "2021.2.5" // "2022.2.7"

/*const csvForm = document.getElementById('csvForm');
csvForm.addEventListener('submit', loadCSV);*/

/** @param {Event} event */
function handleSubmit(event) {
  // The rest of the logic will go here.
}
/*//let mainVersionID = "Shamela0010283";  // Nuwayri
let mainVersionID = "Shamela0011680";  // Istakhri
// later, we'll get the mainVersionID and the OpenITIVersion from the URL:

main(dataBasePath, OpenITIVersion, mainVersionID);*/

function resetGraph(){
  document.getElementById("viz").replaceChildren();
  document.getElementById("viz2").replaceChildren();
  document.getElementById("legend").replaceChildren();
  document.getElementById("filters").replaceChildren();
}

function loadNuwayri(){
  // remove earlier content:
  resetGraph()
  // load new data:
  let mainVersionID = "Shamela0010283";  // Nuwayri
  let OpenITIVersion = "2021.2.5"
  main(dataBasePath, OpenITIVersion, mainVersionID);
}
function loadIstakhri(){
  // remove earlier content:
  resetGraph()
  // load new data:
  let mainVersionID = "Shamela0011680";  // Istakhri
  let OpenITIVersion = "2021.2.5"
  main(dataBasePath, OpenITIVersion, mainVersionID);
}
function loadTarikh(){
  // remove earlier content:
  resetGraph()
  // load new data:
  let mainVersionID = "Shamela0009783BK1";  // Tabari Tarikh
  let OpenITIVersion = "2021.2.5"
  main(dataBasePath, OpenITIVersion, mainVersionID);
}

function loadTafsir(){
  // remove earlier content:
  resetGraph()
  // load new data:
  let mainVersionID = "Shamela0007798";  // Tabari Jāmiʿ Bayān
  let OpenITIVersion = "2022.2.7"
  main(dataBasePath, OpenITIVersion, mainVersionID);
}

function loadTahdhib(){
  // remove earlier content:
  resetGraph()
  // load new data:
  let mainVersionID = "JK008250Vols";  // Tabari Tahdhīb
  let OpenITIVersion = "2022.2.7"
  main(dataBasePath, OpenITIVersion, mainVersionID);
}

function loadCSV(event){
  // remove earlier content:
  resetGraph()
  /*
  // upload data: see https://www.freecodecamp.org/news/upload-files-with-javascript/
  const form = event.currentTarget;
  const formData = new FormData(form);
  const url = new URL(form.action);
  const fetchOptions = {
    method: form.method,
    body: formData
  };
  fetch(url, fetchOptions);
  

  // prevent the page from being reloaded:
  event.preventDefault();*/
  /*// upload data: see https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsText
  //const [file] = document.querySelector("input[type=file]").files;
  const fileReader = new FileReader();
  fileReader.onload = function(event) {
    console.log(event.target.result);
  }
  let file = event.target.files[0];
  fileReader.readAsText(file);*/
  let mainVersionID = "UPLOAD";
  main(dataBasePath, OpenITIVersion, mainVersionID);
}


// try to get the ID of book 1 from the URL;
let thisUrl = parseUrl();
console.log(thisUrl);
if (thisUrl.id1 && !thisUrl.id2) {
  console.log("LOADING "+thisUrl.id1);
  let version = "";
  if (thisUrl.OpenITIVersion.startsWith("v")){
    version = thisUrl.OpenITIVersion.substr(1,thisUrl.OpenITIVersion.length);
  } else {
    version = thisUrl.OpenITIVersion;
  }
  main(dataBasePath, version, thisUrl.id1);
} else {
  loadIstakhri()
}
</script>
